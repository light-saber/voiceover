<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Meta Tags for iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VoiceOver">
    <meta name="theme-color" content="#0f172a">
    
    <title>VoiceOver - Voice Notes</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Prevent text selection for native app feel */
        * {
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Allow text selection only in note content areas */
        .selectable {
            -webkit-user-select: text;
            user-select: text;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
        
        /* Smooth animations */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Pulse animation for recording */
        .pulse-ring {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Dragging state */
        .dragging {
            opacity: 0.5;
        }
        
        /* Smooth height transitions */
        .transition-height {
            transition: height 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen">
    
    <!-- Main App Container -->
    <div id="app" class="max-w-2xl mx-auto min-h-screen flex flex-col">
        
        <!-- Home Screen -->
        <div id="homeScreen" class="flex-1 flex flex-col">
            <!-- Header -->
            <header class="bg-gradient-to-r from-purple-600 to-indigo-600 p-6 shadow-lg">
                <h1 class="text-3xl font-bold text-center">üéôÔ∏è VoiceOver</h1>
                <p class="text-center text-purple-100 text-sm mt-1">Your voice notes companion</p>
            </header>
            
            <!-- Notes List -->
            <div id="notesList" class="flex-1 overflow-y-auto p-4 pb-24">
                <!-- Notes will be rendered here -->
            </div>
            
            <!-- Empty State -->
            <div id="emptyState" class="flex-1 flex items-center justify-center p-8 text-center hidden">
                <div>
                    <div class="text-6xl mb-4">üé§</div>
                    <h2 class="text-xl font-semibold mb-2">No notes yet</h2>
                    <p class="text-slate-400">Tap the microphone to create your first voice note</p>
                </div>
            </div>
            
            <!-- Sticky Record Button -->
            <div class="fixed bottom-0 left-0 right-0 bg-gradient-to-t from-slate-900 via-slate-900 to-transparent p-6 flex justify-center">
                <button id="recordBtn" class="bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white rounded-full w-16 h-16 flex items-center justify-center shadow-2xl transform hover:scale-110 transition-all duration-200">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Recording Modal -->
        <div id="recordingModal" class="hidden fixed inset-0 bg-slate-900 z-50 flex flex-col">
            <div class="flex-1 flex flex-col items-center justify-center p-8">
                <div class="pulse-ring mb-8">
                    <div class="bg-red-500 rounded-full w-24 h-24 flex items-center justify-center shadow-2xl">
                        <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                        </svg>
                    </div>
                </div>
                
                <h2 id="recordingStatus" class="text-2xl font-semibold mb-4">Listening...</h2>
                
                <div class="w-full max-w-md bg-slate-800 rounded-lg p-6 mb-8 min-h-[200px] max-h-[400px] overflow-y-auto">
                    <p id="transcript" class="text-lg selectable leading-relaxed text-slate-300">
                        Start speaking...
                    </p>
                </div>
                
                <div class="flex gap-4">
                    <button id="cancelRecordBtn" class="bg-slate-700 hover:bg-slate-600 text-white px-8 py-3 rounded-full font-semibold transition-all duration-200">
                        Cancel
                    </button>
                    <button id="saveRecordBtn" class="bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-8 py-3 rounded-full font-semibold transition-all duration-200">
                        Save Note
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Note Detail Modal -->
        <div id="noteDetailModal" class="hidden fixed inset-0 bg-slate-900 z-50 flex flex-col">
            <div class="flex-1 flex flex-col">
                <!-- Detail Header -->
                <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-4 flex items-center shadow-lg">
                    <button id="backBtn" class="mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <h2 class="text-xl font-semibold flex-1">Note Details</h2>
                    <button id="deleteNoteBtn" class="text-red-300 hover:text-red-100">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Note Content -->
                <div class="flex-1 overflow-y-auto p-6">
                    <div class="text-sm text-slate-400 mb-4" id="noteDate"></div>
                    <div class="bg-slate-800 rounded-lg p-6 mb-6">
                        <p id="noteContent" class="text-lg selectable leading-relaxed whitespace-pre-wrap"></p>
                    </div>
                </div>
                
                <!-- Append Button -->
                <div class="bg-gradient-to-t from-slate-900 via-slate-900 to-transparent p-6 flex justify-center">
                    <button id="appendBtn" class="bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white px-8 py-3 rounded-full font-semibold flex items-center gap-2 shadow-lg transition-all duration-200">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Append to Note
                    </button>
                </div>
            </div>
        </div>
        
    </div>
    
    <script>
        // ==================== STATE MANAGEMENT ====================
        let notes = [];
        let currentNoteId = null;
        let recognition = null;
        let isAppending = false;
        let currentTranscript = '';
        
        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            loadNotes();
            renderNotes();
            initEventListeners();
            checkSpeechRecognitionSupport();
        });
        
        // ==================== STORAGE ====================
        function loadNotes() {
            const stored = localStorage.getItem('voiceover_notes');
            notes = stored ? JSON.parse(stored) : [];
        }
        
        function saveNotes() {
            localStorage.setItem('voiceover_notes', JSON.stringify(notes));
        }
        
        // ==================== SPEECH RECOGNITION ====================
        function checkSpeechRecognitionSupport() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Speech recognition is not supported in this browser. Please use Safari on iOS or Chrome on desktop.');
            }
        }
        
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                alert('Speech recognition not available');
                return null;
            }
            
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            recognition.onstart = () => {
                document.getElementById('recordingStatus').textContent = 'Listening...';
            };
            
            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                currentTranscript = finalTranscript || interimTranscript;
                const transcriptEl = document.getElementById('transcript');
                transcriptEl.textContent = currentTranscript || 'Start speaking...';
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                
                if (event.error === 'not-allowed') {
                    alert('Microphone permission denied. Please enable microphone access in your browser settings.');
                    closeRecordingModal();
                } else if (event.error === 'no-speech') {
                    document.getElementById('recordingStatus').textContent = 'No speech detected. Keep speaking...';
                } else {
                    alert('Error: ' + event.error);
                }
            };
            
            recognition.onend = () => {
                // Auto-restart if still in recording mode
                if (document.getElementById('recordingModal').classList.contains('hidden') === false) {
                    try {
                        recognition.start();
                    } catch (e) {
                        console.log('Recognition restart failed:', e);
                    }
                }
            };
            
            return recognition;
        }
        
        // ==================== UI RENDERING ====================
        function renderNotes() {
            const notesList = document.getElementById('notesList');
            const emptyState = document.getElementById('emptyState');
            
            if (notes.length === 0) {
                notesList.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            notesList.innerHTML = notes.map((note, index) => `
                <div class="bg-slate-800 rounded-lg p-4 mb-3 shadow-lg fade-in hover:bg-slate-750 transition-colors duration-200" data-note-id="${note.id}">
                    <div class="flex items-start gap-3">
                        <!-- Drag Handle -->
                        <div class="flex flex-col gap-1 pt-1 drag-handle cursor-move">
                            <button class="text-slate-500 hover:text-slate-300" onclick="moveNote(${index}, -1)">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                                </svg>
                            </button>
                            <button class="text-slate-500 hover:text-slate-300" onclick="moveNote(${index}, 1)">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Note Content -->
                        <div class="flex-1 cursor-pointer" onclick="openNoteDetail('${note.id}')">
                            <p class="text-slate-300 line-clamp-2 mb-2">${note.content.substring(0, 100)}${note.content.length > 100 ? '...' : ''}</p>
                            <p class="text-xs text-slate-500">${formatDate(note.date)}</p>
                        </div>
                        
                        <!-- Delete Button -->
                        <button class="text-red-400 hover:text-red-300 p-1" onclick="deleteNote('${note.id}')">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        // ==================== NOTE OPERATIONS ====================
        function createNote(content) {
            const note = {
                id: Date.now().toString(),
                content: content.trim(),
                date: Date.now()
            };
            notes.unshift(note);
            saveNotes();
            renderNotes();
        }
        
        function deleteNote(id) {
            if (confirm('Are you sure you want to delete this note?')) {
                notes = notes.filter(note => note.id !== id);
                saveNotes();
                renderNotes();
            }
        }
        
        function moveNote(index, direction) {
            if (index + direction < 0 || index + direction >= notes.length) return;
            
            const temp = notes[index];
            notes[index] = notes[index + direction];
            notes[index + direction] = temp;
            
            saveNotes();
            renderNotes();
        }
        
        function appendToNote(id, content) {
            const note = notes.find(n => n.id === id);
            if (note) {
                note.content += '\n\n' + content.trim();
                note.date = Date.now(); // Update timestamp
                saveNotes();
                renderNotes();
                openNoteDetail(id); // Refresh the detail view
            }
        }
        
        // ==================== MODAL CONTROLS ====================
        function openRecordingModal() {
            currentTranscript = '';
            isAppending = false;
            document.getElementById('recordingModal').classList.remove('hidden');
            document.getElementById('transcript').textContent = 'Start speaking...';
            
            if (!recognition) {
                recognition = initSpeechRecognition();
            }
            
            if (recognition) {
                try {
                    recognition.start();
                } catch (e) {
                    console.log('Recognition already started or error:', e);
                }
            }
        }
        
        function closeRecordingModal() {
            document.getElementById('recordingModal').classList.add('hidden');
            if (recognition) {
                recognition.stop();
            }
        }
        
        function openNoteDetail(id) {
            currentNoteId = id;
            const note = notes.find(n => n.id === id);
            
            if (note) {
                document.getElementById('noteContent').textContent = note.content;
                document.getElementById('noteDate').textContent = formatDate(note.date);
                document.getElementById('noteDetailModal').classList.remove('hidden');
            }
        }
        
        function closeNoteDetail() {
            document.getElementById('noteDetailModal').classList.add('hidden');
            currentNoteId = null;
        }
        
        function openAppendModal() {
            currentTranscript = '';
            isAppending = true;
            document.getElementById('noteDetailModal').classList.add('hidden');
            document.getElementById('recordingModal').classList.remove('hidden');
            document.getElementById('transcript').textContent = 'Start speaking...';
            
            if (!recognition) {
                recognition = initSpeechRecognition();
            }
            
            if (recognition) {
                try {
                    recognition.start();
                } catch (e) {
                    console.log('Recognition already started or error:', e);
                }
            }
        }
        
        // ==================== EVENT LISTENERS ====================
        function initEventListeners() {
            // Record button
            document.getElementById('recordBtn').addEventListener('click', openRecordingModal);
            
            // Recording modal buttons
            document.getElementById('cancelRecordBtn').addEventListener('click', closeRecordingModal);
            document.getElementById('saveRecordBtn').addEventListener('click', () => {
                if (currentTranscript.trim()) {
                    if (isAppending && currentNoteId) {
                        appendToNote(currentNoteId, currentTranscript);
                    } else {
                        createNote(currentTranscript);
                    }
                }
                closeRecordingModal();
            });
            
            // Note detail modal buttons
            document.getElementById('backBtn').addEventListener('click', closeNoteDetail);
            document.getElementById('appendBtn').addEventListener('click', openAppendModal);
            document.getElementById('deleteNoteBtn').addEventListener('click', () => {
                if (currentNoteId) {
                    deleteNote(currentNoteId);
                    closeNoteDetail();
                }
            });
        }
        
        // ==================== GLOBAL FUNCTIONS ====================
        // These are called from inline onclick handlers
        window.deleteNote = deleteNote;
        window.moveNote = moveNote;
        window.openNoteDetail = openNoteDetail;
    </script>
</body>
</html>
